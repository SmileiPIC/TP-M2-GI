\documentclass{article}


\title{\vspace{-2.cm}Preparing  your environment for the practical}
%\author{F. Massimo
%}
%\date{December 2019}

\usepackage[left=3cm, right=3cm, top=3cm]{geometry}
\usepackage[utf8]{inputenc}
\usepackage{bold-extra}
\usepackage{booktabs}
\usepackage{latexsym}
\usepackage{amssymb}
\usepackage{amsmath}
\usepackage{url}
\usepackage{graphicx}
%\usepackage{sidecap}		
\usepackage{subfigure}
\usepackage{epsfig}		
\usepackage{epstopdf}
\usepackage{dcolumn}	
\usepackage{bm}		
\usepackage[dvipsnames]{xcolor}
\usepackage[normalem]{ulem}	
\usepackage{xspace}
\usepackage{lmodern}

% (2) specify encoding
\usepackage[T1]{fontenc}

% (3) load symbol definitions
\usepackage{textcomp}

\newcommand{\smilei}{{\sc Smilei}\xspace}
\newcommand{\commandline}[1]{\texttt{\textbf{#1}}}

\begin{document}

\maketitle

\tableofcontents


%%% ------------------------------------------------------------------------------------------------------------------------------------------------

\section{Login to the cluster}
\begin{itemize}

\item It may be useful to open the documentation of \smilei in the web browser:\\
 	\commandline{\url{http://www.maisondelasimulation.fr/smilei}}	\\
	In particular, the documentation explaining the entries of the input namelist (but normally you should find all the necessary explanations in the handouts):\\
\commandline{\url{https://smileipic.github.io/Smilei/namelist.html}}

\item Open a shell/Terminal window to work on command line

\item Login to the the Ruche cluster and then enter your password, which will not appear on your screen (see the access credentials you have received):\\
\commandline{ssh -XY username@...}\\

Once you are connected you will be in your home space,  whose path is also referenced with the shortcut \commandline{\$HOME}.
It is highly recommended to use this space only to compile the code. As explained in the following, run your simulations in the space called \commandline{\$WORKDIR}. 
\end{itemize}


\section{Compile the code \smilei}
\begin{itemize}
\item Download \smilei:\\
\commandline{git clone https://github.com/SmileiPIC/Smilei.git}\\
and then enter the newly created folder \commandline{Smilei}:\\
\commandline{cd Smilei}

\item Clean potentially incomplete build files:\\
\commandline{make clean}

\item Compile the code from the code folder:\\
\commandline{make -j 10 machine=ruche}\\
This should create the files called \commandline{smilei} and \commandline{smilei\_test}.
If you see the line \commandline{Linking smilei\_test for test mode} and no errors are displayed, everything should have worked well.
It is normal to see messages like \commandline{In file included from ...}

\item Compile the postprocessing library \commandline{happi}:\\
\commandline{make happi}

\item To know the location of your executable file, just use:\\
\commandline{pwd}\\
This command will display the path to your current working directory,  for example \commandline{path/to/executable}. This path will be used later. Now your executables \commandline{smilei} and \commandline{smilei\_test} should be found in your folder \commandline{path/to/executable}.

\end{itemize}

\section{Prepare your simulation}
\begin{itemize}


\item Enter your working space:\\
\commandline{cd \$WORKDIR}

\item Create a new directory \texttt{sim} where you will run your simulation:\\
\commandline{mkdir sim}\\
\commandline{cd sim}

\item Inside this folder, create a link to the executables:\\
\commandline{ln -s path/to/executable/smilei}\\
\commandline{ln -s path/to/executable/smilei\_test}\\
The expression \commandline{path/to/executable} is just an example, you will need to insert the path where your files \commandline{smilei} and \commandline{smilei\_test} are.

\item Inside this folder, you will need a file to submit a simulation job to the job scheduler, e.g. \commandline{submission\_script.sh}. You can transfer the file you already have through \commandline{scp} or just copy and paste it in a new file inside your simulation folder. 

\item Inside this folder, you will need also the input file of your simulation \commandline{InputNamelist.py}. Once you have all these files in your simulation folder (executables, submission script, input namelist) you are ready to run your simulation. If you change the name of your namelist,  remember that it must be a \commandline{.py} file and it must appear a the end of the \commandline{submission\_script.sh}.

\section{Run your simulation}
\item IMPORTANT WARNING: do NOT launch a simulation directly,  always use a simulation job submission script as described below. You are now connected in the login nodes of the cluster,  made to transfer files and compile codes, and shared among the connected users.  If you launch a simulation directly it will be run on this shared space where all the machine users can connect, slowing down or blocking their operations.  Imagine to have a very slow home wifi connection, sufficient only to send some e-mails to work, shared among you and many house-mates.  In this analogy running a simulation directly on the login node is equivalent to start a long video-call, blocking everyone elses' attempt to send e-mails and work properly. \\

Instead, launching a simulation with a job submission script as described in the following will make the simulation run on the compute nodes, where the necessary resources are safely distributed among the machine users.  Science is also learning to work together and to respect each other's space.\\

\item Check if you have all the required files (executables, submission script, input namelist) through the command:\\
\commandline{ls}

\item To check that your namelist does not contain syntax errors, use the \commandline{smilei\_test} executable on the namelist (you'll need to load the same libraries used for the code compilation):\\
\commandline{./smilei\_test InputNamelist.py}\\
If you see the line \commandline{END TEST MODE}, the namelist does not contain syntax errors and can be run.

\item Launch your simulation job:\\
\commandline{sbatch submission\_script.sh}

\item To check the status (running/queueing etc) of yout job:\\
\commandline{squeue -u username}\\
This should also give you the number \commandline{JobId} of your job, necessary for the next command.

\item To delete your job from the queue:\\
\commandline{scancel JobId}

\item To read the end of the log file and let it refresh (if you want to watch your simulation execute for example):\\
\commandline{tail -f smilei.log}\\
ctrl+C will allow you to stop watching the file refresh.

\item If you want to change the time you want for your simulation, change the corresponding line in the file \commandline{submission\_script.sh} (here 20 minutes):\\
\commandline{\#SBATCH --time=00:20:00}\\
The longest simulation of the session runs approximately for 3 minutes with 10 MPI processes and 2 OpenMP threads. These parameters are already set in the submission script.

\item If you want to change the number of OpenMP threads in your simulation, change the corresponding line in the file \commandline{submission\_script.sh} (here 2 threads):\\
\commandline{export OMP\_NUM\_THREADS=2}

\item If you want to change the number of MPI process in your simulation, change the corresponding line in the file \commandline{submission\_script.sh} (here 10 processes):\\
\commandline{\#SBATCH --ntasks=10}

\end{itemize}


\section{Postprocess your simulation results}

\begin{itemize}
\item Open \commandline{IPython} (before, you will need to load the Python modules and define variables like how you did to compile the code, and be sure you have compiled \commandline{happi}):\\
\commandline{ipython}

\item Import the libraries you need:\\
\commandline{import happi}\\
\commandline{import numpy as np}\\
\commandline{import matplotlib.pyplot as plt}

The output files have the extension \commandline{.h5} and can be opened with the postprocessing library \commandline{happi}. You will need also the file \commandline{smilei.py}, generated at the start of your simulation.

\item Open your simulation:\\
\commandline{S = happi.Open("path/to/my/results")}\\
again, \commandline{"path/to/my/results"} is an example, you will need to put the path of your simulation. If you use simply \commandline{S = happi.Open()}, the library \commandline{happi} will open the results inside the current working directory.

\item Now you can use the commands in the section \textbf{Crash course on the \commandline{happi} postprocessing library} in the handouts.

\end{itemize}


\section{Command line cheatsheet}

\begin{itemize}

\item{\commandline{pwd}} : shows the path of the current working directory.

\item \commandline{cd path} :  go to \texttt{path}

\item \commandline{ls} :  see the content of the current directory. 

\item \commandline{ls path} :  see the content in \texttt{path}.

\item \commandline{rm file} : removes \commandline{file}. To remove a folder, you will need an additional flag: \commandline{rm -r folder}.

\item \commandline{cp source\_file destination\_path} :  copies  \commandline{source\_file} to the \commandline{destination\_path}.

\item \commandline{scp source\_file destination\_path} :  same as \commandline{cp}, but you can also transfer folders and files to a different machine, e.g. from the cluster to your computer and vice versa. You will be asked to provide your username, the server address and your password, e.g. \commandline{scp source\_file username@server:/destination\_path/}. This command can be used to transfer output files from the cluster to your computer for later postprocessing if so you prefer (of course larger data files will need more time to transfer).

\item \commandline{mv source destination} : move \commandline{source} (can be a file or directory) to a \commandline{destination}. If the \commandline{destination} does not specify a path, the command renames \commandline{source} with the name \commandline{destination}.

\item \commandline{ipython} : opens \commandline{Ipython}, where also the previous commands can be used. To run a Python script inside this interface, use \commandline{\%run script\_name.py}.





\end{itemize}


 


\end{document}

